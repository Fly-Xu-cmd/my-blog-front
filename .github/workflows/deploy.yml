name: Deploy Next.js App to Aliyun

on:
  push:
    branches:
      - main

env:
  DEPLOY_USER: appuser
  DEPLOY_DIR: /home/www/my-blog

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§± Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: pnpm prisma generate
        env:
          DATABASE_URL: "mysql://placeholder:placeholder@localhost:3306/placeholder"

      - name: ğŸ—ï¸ Build Next.js project
        run: pnpm build
        env:
          NEXT_PUBLIC_SITE_URL: https://${{ secrets.ALIYUN_SERVER_IP }}

      - name: ğŸ“ Prepare deploy package
        run: |
          mkdir -p deploy
          cp -r .next package.json pnpm-lock.yaml prisma public deploy/
          echo "Done packaging."

      - name: âœ¨ Ensure appuser exists & directories ready (root)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            echo "ğŸ”§ Ensuring deploy user and dirs..."

            id appuser || useradd -m -s /bin/bash appuser
            mkdir -p /home/www/my-blog
            mkdir -p /home/www/my-blog/shared/upload

            chown -R appuser:appuser /home/www/my-blog

            echo "Root stage complete."

      - name: ğŸ“¤ Upload build to server (as appuser)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: appuser
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          source: "deploy/*"
          target: "${{ env.DEPLOY_DIR }}/tmp-deploy"
          strip_components: 1
          timeout: 120s

      - name: ğŸš€ Deploy application with PM2 (appuser)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: appuser
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            cd /home/www/my-blog

            echo "ğŸ§¹ Cleaning old build"
            rm -rf .next prisma public tmp || true

            echo "ğŸ“¦ Moving new build"
            mv tmp-deploy/.next .
            mv tmp-deploy/prisma .
            mv tmp-deploy/public .
            mv tmp-deploy/package.json .
            mv tmp-deploy/pnpm-lock.yaml .

            echo "ğŸ”§ Ensuring shared/upload exists"
            mkdir -p shared/upload
            chmod -R 775 shared/upload

            echo "ğŸ”— Recreate symlink public/upload â†’ shared/upload"
            rm -rf public/upload
            ln -s /home/www/my-blog/shared/upload /home/www/my-blog/public/upload

            echo "ğŸ“¦ Installing production deps"
            pnpm install --prod --frozen-lockfile --silent

            echo "ğŸ”§ Prisma generate"
            pnpm prisma generate

            echo "ğŸ—„ï¸ Prisma migrate"
            pnpm prisma migrate deploy

            echo "ğŸ”¥ Restarting PM2"
            pm2 stop my-blog || true
            pm2 delete my-blog || true
            pm2 start "pnpm start" --name my-blog --time

            echo "ğŸ“Š PM2 Status"
            pm2 list

            echo "ğŸ‰ Deployment completed!"
