name: Deploy Next.js App to Aliyun

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯æ¨é€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Install system dependencies (MySQL client)
        run: |
          sudo apt-get update
          sudo apt-get install -y libmysqlclient-dev  # Prisma MySQL é©±åŠ¨ä¾èµ–
          echo "âœ… System dependencies installed"

      - name: ğŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ§© Install project dependencies
        run: pnpm install --frozen-lockfile
        env:
          # å®‰è£…æ—¶å¿½ç•¥ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼Œé¿å…æœ¬åœ°é…ç½®å¹²æ‰°
          NODE_ENV: development

      - name: ğŸ§± Generate Prisma client (build stage)
        run: pnpm prisma generate
        env:
          # æ„å»ºé˜¶æ®µæ— éœ€çœŸå®æ•°æ®åº“è¿æ¥ï¼Œä»…ç”Ÿæˆå®¢æˆ·ç«¯
          DATABASE_URL: "mysql://placeholder:placeholder@localhost:3306/placeholder"

      - name: ğŸ—ï¸ Build Next.js project
        run: pnpm build
        env:
          # æ„å»ºæ—¶å¯èƒ½éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®éœ€æ±‚æ·»åŠ ï¼‰
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

      - name: ğŸ“ Prepare deploy package
        run: |
          mkdir -p deploy
          # å¤åˆ¶å¿…è¦çš„éƒ¨ç½²æ–‡ä»¶
          cp -r .next package.json pnpm-lock.yaml prisma deploy/
          [ -d public ] && cp -r public deploy/public
          [ -f ecosystem.config.js ] && cp ecosystem.config.js deploy/
          # æ£€æŸ¥æ‰“åŒ…ç»“æœ
          echo "âœ… Deploy package structure:"
          ls -la deploy/
          echo "ğŸ“¦ .next directory check:"
          ls -la deploy/.next/

      - name: ğŸ“¤ Upload build to Aliyun server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: appuser
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          source: "deploy/*"
          target: "/home/www/my-blog"
          strip_components: 1 # ç§»é™¤ deploy å¤–å±‚ç›®å½•
          timeout: 60s # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé¿å…å¤§æ–‡ä»¶ä¼ è¾“å¤±è´¥

      - name: ğŸš€ Setup application user and permissions
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            echo "ğŸš€ Setting up application user and permissions"

            # åˆ›å»ºåº”ç”¨ç”¨æˆ·å’Œç»„
            echo "ğŸ‘¥ Creating appuser"
            groupadd -f appuser || true
            useradd -g appuser -m -s /bin/bash appuser || true

            # åˆ›å»ºåº”ç”¨ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            echo "ğŸ“ Creating application directory"
            mkdir -p /home/www/my-blog

            # è®¾ç½®ç›®å½•æ‰€æœ‰æƒ
            echo "ğŸ‘¤ Setting ownership to appuser"
            chown -R appuser:appuser /home/www/my-blog

            # ç¡®ä¿appuserèƒ½å¤Ÿè®¿é—®å…¨å±€åŒ…
            echo "ğŸ”§ Setting up global package access for appuser"
            # è·å–å…¨å±€åŒ…è·¯å¾„
            GLOBAL_PREFIX=$(npm config get prefix)
            echo "ğŸ“ Global prefix: $GLOBAL_PREFIX"

            # è®¾ç½®appuserçš„PATHç¯å¢ƒå˜é‡
            usermod -a -G sudo appuser 2>/dev/null || true
            echo 'export PATH=$GLOBAL_PREFIX/bin:$PATH' >> /home/appuser/.bashrc
            echo 'export PATH=$GLOBAL_PREFIX/bin:$PATH' >> /home/appuser/.profile

            # ç¡®ä¿å…¨å±€åŒ…çš„æ‰§è¡Œæƒé™
            chmod -R 755 $GLOBAL_PREFIX/bin/ 2>/dev/null || true

            echo "âœ… User and directory setup completed"

      - name: ğŸš€ Deploy application with appuser
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: appuser
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment with appuser"
            cd /home/www/my-blog || { echo "âŒ Directory not found"; exit 1; }

            # ç¡®ä¿ç›®å½•å’Œæ–‡ä»¶æƒé™æ­£ç¡®
            echo "ğŸ”§ Setting proper permissions"
            chmod -R 755 .next public prisma

            # ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨ä¸”å¯å†™
            echo "ğŸ“ Creating and configuring upload directory"
            mkdir -p public/uploads
            chmod -R 775 public/uploads

            echo "ğŸ§¹ Cleaning obsolete files"
            find . -mindepth 1 -maxdepth 1 \
              ! -name 'prisma' \
              ! -name '.next' \
              ! -name 'package.json' \
              ! -name 'pnpm-lock.yaml' \
              ! -name 'public' \
              ! -name '.env' \
              -exec rm -rf {} + 2>/dev/null || true
            rm -rf prisma/*.db prisma/*.db-* 2>/dev/null || true

            echo "ğŸ“¦ Verifying files"
            if [ ! -f "package.json" ] || [ ! -d ".next" ]; then
              echo "âŒ Critical files missing"
              exit 1
            fi

            echo "ğŸ”§ Verifying pnpm availability"
            # åŠ è½½å…¨å±€åŒ…è·¯å¾„
            source ~/.bashrc || true
            source ~/.profile || true

            if ! command -v pnpm &> /dev/null; then
              echo "âŒ pnpm not found, checking global prefix"
              # å°è¯•ä½¿ç”¨ç»å¯¹è·¯å¾„
              NPM_PREFIX=$(npm config get prefix 2>/dev/null)
              if [ -n "$NPM_PREFIX" ] && [ -f "$NPM_PREFIX/bin/pnpm" ]; then
                echo "ğŸ“ Found pnpm at: $NPM_PREFIX/bin/pnpm"
                export PATH="$NPM_PREFIX/bin:$PATH"
              else
                echo "âŒ pnpm not available in global packages"
                exit 1
              fi
            fi

            echo "ğŸ“¦ Installing production dependencies"
            pnpm install --prod --frozen-lockfile --silent || { echo "âŒ Dependency install failed"; exit 1; }

            echo "ğŸ”„ Generating Prisma client"
            pnpm prisma generate || { echo "âŒ Prisma client generation failed"; exit 1; }

            echo "ğŸ—„ï¸ Applying migrations"
            pnpm prisma migrate deploy || { echo "âŒ Migration failed"; exit 1; }

            # ç§»é™¤è¿æ¥æµ‹è¯•æ­¥éª¤ï¼ˆå›  migrate å·²éªŒè¯è¿æ¥æ­£å¸¸ï¼‰
            echo "âœ… Skipping redundant connection test (migrations succeeded)"

            # éªŒè¯ç¯å¢ƒæƒé™è®¾ç½®
            echo "ğŸ” Verifying environment permissions"
            echo "Current user: $(whoami)"
            echo "Directory permissions: $(ls -la | head -n 1)"

            echo "âœ… Restarting with PM2 as non-root user"
            # éªŒè¯PM2æ˜¯å¦å¯ç”¨
            if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 not found, checking global prefix"
              # å°è¯•ä½¿ç”¨ç»å¯¹è·¯å¾„
              NPM_PREFIX=$(npm config get prefix 2>/dev/null)
              if [ -n "$NPM_PREFIX" ] && [ -f "$NPM_PREFIX/bin/pm2" ]; then
                echo "ğŸ“ Found PM2 at: $NPM_PREFIX/bin/pm2"
                export PATH="$NPM_PREFIX/bin:$PATH"
              else
                echo "âŒ PM2 not available in global packages"
                exit 1
              fi
            fi

            # ç¡®ä¿PM2ç›®å½•æƒé™æ­£ç¡®
            mkdir -p ~/.pm2
            chmod -R 755 ~/.pm2

            echo "ğŸ›‘ Stopping previous instance"
            pm2 stop my-blog || true
            pm2 delete my-blog || true

            echo "ğŸš€ Starting application"
            pm2 start "pnpm start" --name my-blog || { echo "âŒ App start failed"; exit 1; }

            echo "ğŸ“Š Application status"
            pm2 list

            # éªŒè¯åº”ç”¨æ˜¯å¦æ­£å¸¸å¯åŠ¨
            sleep 5
            if ! pm2 status my-blog | grep -q "online"; then
              echo "âš ï¸  Warning: Application might not be running properly"
              echo "Latest logs:" 
              pm2 logs my-blog --lines 20 || true
            else
              echo "âœ… Application successfully started"
            fi

            echo "ğŸ‰ Deployment completed successfully!"
