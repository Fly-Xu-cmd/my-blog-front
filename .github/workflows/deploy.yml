name: Deploy Next.js (App Router + Prisma)

on:
  push:
    branches:
      - main # ä½ å¯ä»¥æ”¹æˆ dev æˆ–å…¶ä»–åˆ†æ”¯

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ å®‰è£… pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # 5ï¸âƒ£ ç¡®ä¿ Prisma Client ç”Ÿæˆ
      - name: Generate Prisma Client
        run: |
          if [ -d "prisma" ] && [ -f "prisma/schema.prisma" ]; then
            echo "ğŸ”§ Generating Prisma client..."
            npx prisma generate
          else
            echo "âš ï¸ No prisma/schema.prisma found!"
          fi

      # 6ï¸âƒ£ æ„å»º Next.js
      - name: Build Next.js project
        run: pnpm run build

      # 7ï¸âƒ£ æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
      - name: Prepare deploy files
        run: |
          echo "ğŸ“¦ Preparing deployment package..."
          mkdir -p deploy
          cp -r .next package.json pnpm-lock.yaml prisma deploy/
          [ -d public ] && cp -r public deploy/public
          [ -d app ] && cp -r app deploy/app
          echo "âœ… Files ready in ./deploy"

      # 8ï¸âƒ£ ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ä¸´æ—¶ç›®å½•
      - name: Upload build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          source: "deploy/*"
          target: "/root/deploy_temp"

      # 9ï¸âƒ£ SSH éƒ¨ç½²è„šæœ¬ï¼ˆè‡ªåŠ¨åˆ›å»ºç›®å½• + ä¿ç•™ Prisma æ•°æ®ï¼‰
      - name: Deploy on Aliyun
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."

            PROJECT_DIR="/root/my-blog"
            TEMP_DIR="/root/deploy_temp"

            # è‡ªåŠ¨åˆ›å»ºé¡¹ç›®ç›®å½•
            mkdir -p $PROJECT_DIR

            # ä¿ç•™æ—§æ•°æ®åº“
            if [ -f "$PROJECT_DIR/prisma/dev.db" ]; then
              echo "ğŸ—„ï¸  Backing up Prisma database..."
              cp "$PROJECT_DIR/prisma/dev.db" /root/dev.db.bak
            fi

            echo "ğŸ“¦ Updating project files..."
            cp -r $TEMP_DIR/* $PROJECT_DIR/

            # æ¢å¤æ•°æ®åº“
            if [ -f "/root/dev.db.bak" ]; then
              echo "â™»ï¸ Restoring previous Prisma database..."
              cp /root/dev.db.bak $PROJECT_DIR/prisma/dev.db
            fi

            cd $PROJECT_DIR

            # ç¡®ä¿ pnpm å­˜åœ¨
            if ! command -v pnpm &> /dev/null; then
              echo "ğŸ“¦ Installing pnpm..."
              npm install -g pnpm
            fi

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --prod

            # ç”Ÿæˆ Prisma Clientï¼ˆæœåŠ¡å™¨ç«¯ä¹Ÿè¦æœ‰ï¼‰
            echo "ğŸ”§ Generating Prisma client..."
            npx prisma generate

            # ä½¿ç”¨ pm2 å¯åŠ¨ Next.js æœåŠ¡
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Installing pm2..."
              npm install -g pm2
            fi

            # å¯åŠ¨ Next.js åº”ç”¨
            echo "ğŸš€ Starting Next.js app with pm2..."
            pm2 delete my-blog || true
            pm2 start "pnpm run start" --name "my-blog" --cwd $PROJECT_DIR

            pm2 save
            echo "âœ… Deployment complete!"
