name: Deploy Next.js Blog to Aliyun

on:
  push:
    branches:
      - main # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      # 3ï¸âƒ£ å®‰è£… pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5ï¸âƒ£ æ„å»ºé¡¹ç›®ï¼ˆåœ¨ GitHub æœåŠ¡å™¨ä¸Šå®Œæˆï¼‰
      - name: Build project
        run: pnpm build

      # 6ï¸âƒ£ æ‰“åŒ…éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
      - name: Prepare deploy files
        run: |
          mkdir -p deploy
          cp -r .next package.json pnpm-lock.yaml deploy/
          [ -d public ] && cp -r public deploy/public
          echo "âœ… Build files prepared successfully"

      # 7ï¸âƒ£ ä¸Šä¼ åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      - name: Deploy to Aliyun Server
        env:
          ALIYUN_SERVER_IP: ${{ secrets.ALIYUN_SERVER_IP }}
          ALIYUN_SSH_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
        run: |
          echo "ğŸ”‘ Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "$ALIYUN_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "ğŸš€ Deploying to $ALIYUN_SERVER_IP..."
          # å¤åˆ¶æ„å»ºç»“æœåˆ°æœåŠ¡å™¨ç›®å½•ï¼ˆä¾‹å¦‚ /home/www/my-blogï¼‰
          rsync -avz --delete deploy/ root@$ALIYUN_SERVER_IP:/home/www/my-blog

      # 8ï¸âƒ£ åœ¨æœåŠ¡å™¨ä¸Šé‡å¯æœåŠ¡
      - name: Restart Next.js Service
        env:
          ALIYUN_SERVER_IP: ${{ secrets.ALIYUN_SERVER_IP }}
          ALIYUN_SSH_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
        run: |
          echo "ğŸ” Restarting Next.js service on server..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@$ALIYUN_SERVER_IP "
            cd /home/www/my-blog &&
            pnpm install --prod &&
            pm2 delete my-blog || true &&
            pm2 start pnpm --name my-blog -- start
          "
