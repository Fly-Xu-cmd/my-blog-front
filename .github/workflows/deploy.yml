name: Deploy Next.js App to Aliyun

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯æ¨é€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Install system dependencies (MySQL client)
        run: |
          sudo apt-get update
          sudo apt-get install -y libmysqlclient-dev  # Prisma MySQL é©±åŠ¨ä¾èµ–
          echo "âœ… System dependencies installed"

      - name: ğŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ§© Install project dependencies
        run: pnpm install --frozen-lockfile
        env:
          # å®‰è£…æ—¶å¿½ç•¥ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼Œé¿å…æœ¬åœ°é…ç½®å¹²æ‰°
          NODE_ENV: development

      - name: ğŸ§± Generate Prisma client (build stage)
        run: pnpm prisma generate
        env:
          # æ„å»ºé˜¶æ®µæ— éœ€çœŸå®æ•°æ®åº“è¿æ¥ï¼Œä»…ç”Ÿæˆå®¢æˆ·ç«¯
          DATABASE_URL: "mysql://placeholder:placeholder@localhost:3306/placeholder"

      - name: ğŸ—ï¸ Build Next.js project
        run: pnpm build
        env:
          # æ„å»ºæ—¶å¯èƒ½éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®éœ€æ±‚æ·»åŠ ï¼‰
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

      - name: ğŸ“ Prepare deploy package
        run: |
          mkdir -p deploy
          # å¤åˆ¶å¿…è¦çš„éƒ¨ç½²æ–‡ä»¶
          cp -r .next package.json pnpm-lock.yaml prisma deploy/
          [ -d public ] && cp -r public deploy/public
          [ -f ecosystem.config.js ] && cp ecosystem.config.js deploy/
          # æ£€æŸ¥æ‰“åŒ…ç»“æœ
          echo "âœ… Deploy package structure:"
          ls -la deploy/
          echo "ğŸ“¦ .next directory check:"
          ls -la deploy/.next/

      - name: ğŸ“¤ Upload build to Aliyun server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          source: "deploy/*"
          target: "/home/www/my-blog"
          strip_components: 1 # ç§»é™¤ deploy å¤–å±‚ç›®å½•
          timeout: 60s # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé¿å…å¤§æ–‡ä»¶ä¼ è¾“å¤±è´¥

      - name: ğŸš€ Deploy and start application on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment process on server"
            cd /home/www/my-blog || { echo "âŒ Directory not found"; exit 1; }

            echo "ğŸ§¹ Cleaning obsolete files"
            # ä¿ç•™å…³é”®æ–‡ä»¶ï¼Œåˆ é™¤å…¶ä»–å†—ä½™å†…å®¹
            find . -mindepth 1 -maxdepth 1 \
              ! -name 'prisma' \
              ! -name '.next' \
              ! -name 'package.json' \
              ! -name 'pnpm-lock.yaml' \
              ! -name 'public' \
              ! -name '.env' \
              -exec rm -rf {} + 2>/dev/null || true

            echo "ğŸ“¦ Verifying deployment files"
            if [ ! -f "package.json" ] || [ ! -d ".next" ]; then
              echo "âŒ Critical files missing (package.json or .next)"
              exit 1
            fi

            echo "ğŸ”§ Ensuring pnpm is installed"
            if ! command -v pnpm &> /dev/null; then
              echo "Installing pnpm..."
              npm install -g pnpm
            fi

            echo "ğŸ“¦ Installing production dependencies"
            pnpm install --prod --frozen-lockfile --silent || { echo "âŒ Dependency install failed"; exit 1; }

            echo "ğŸ”„ Generating Prisma client (production)"
            pnpm prisma generate || { echo "âŒ Prisma client generation failed"; exit 1; }

            echo "ğŸ—„ï¸ Applying database migrations"
            pnpm prisma migrate deploy || { echo "âŒ Migration failed"; exit 1; }

            echo "ğŸ” Testing database connection"
            if ! pnpm prisma db pull --dry-run &> /dev/null; then
              echo "âŒ Database connection failed"
              exit 1
            fi

            echo "âœ… Restarting application with PM2"
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              npm install -g pm2
            fi
            pm2 stop my-blog || true
            pm2 delete my-blog || true
            pm2 start "pnpm start" --name my-blog || { echo "âŒ App start failed"; exit 1; }

            echo "ğŸ“Š Application status"
            pm2 list

            echo "ğŸ‰ Deployment completed successfully!"
