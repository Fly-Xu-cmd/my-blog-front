name: Deploy Next.js to Aliyun Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v2

      # 2. 设置 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "18"

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          npm install -g pnpm
          pnpm install

      # 4. 创建 Prisma Client
      - name: Create Prisma Client
        run: pnpm prisma generate

      # 5. 构建项目
      - name: Build Next.js project
        run: pnpm run build

      # 6. 部署到阿里云
      - name: Deploy to Aliyun
        env:
          ALIYUN_SERVER_IP: ${{ secrets.ALIYUN_SERVER_IP }}
          ALIYUN_SSH_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
        run: |
          # 安装 SSH 客户端
          sudo apt-get install -y openssh-client

          # 设置 SSH 密钥
          mkdir -p ~/.ssh
          echo "$ALIYUN_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 检查 ALIYUN_SERVER_IP 是否存在
          if [ -z "$ALIYUN_SERVER_IP" ]; then
            echo "Error: ALIYUN_SERVER_IP is not set."
            exit 1
          fi

          # 配置 SSH
          echo -e "Host $ALIYUN_SERVER_IP\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

          # 连接到阿里云服务器并部署
          ssh -T root@$ALIYUN_SERVER_IP << 'EOF'
            cd /home/www/my-blog-front
            git pull origin main
            pnpm install
            pnpm run build
            pm2 restart my-blog-front || pm2 start npm --name "my-blog-front" -- start
          EOF
