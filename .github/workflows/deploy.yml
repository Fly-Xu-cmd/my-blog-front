name: Deploy Next.js App to Aliyun

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯æ¨é€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Install system dependencies (MySQL client + openssl)
        run: |
          sudo apt-get update
          sudo apt-get install -y libmysqlclient-dev openssl
          echo "âœ… System dependencies installed"

      - name: ğŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ§© Install project dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_ENV: development

      - name: ğŸ§± Generate Prisma client (build stage)
        run: |
          for i in {1..3}; do
            pnpm prisma generate --timeout 60000 && break
            echo "Retrying Prisma generate (attempt $i)..."
            sleep 5
          done
          if [ $i -eq 3 ]; then
            echo "âŒ Prisma generate failed after 3 attempts"
            exit 1
          fi
        env:
          DATABASE_URL: "mysql://placeholder:placeholder@localhost:3306/placeholder"
          PRISMA_BINARIES_MIRROR: "https://r.cnpmjs.org/prisma-binaries/"

      - name: ğŸ—ï¸ Build Next.js project
        run: pnpm build
        env:
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

      - name: ğŸ“ Prepare deploy package
        run: |
          mkdir -p deploy
          cp -r .next package.json pnpm-lock.yaml prisma deploy/
          [ -d public ] && cp -r public deploy/public
          [ -f ecosystem.config.js ] && cp ecosystem.config.js deploy/
          echo "âœ… Deploy package structure:"
          ls -la deploy/

      - name: ğŸ“¤ Upload build to Aliyun server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          source: "deploy/*"
          target: "/home/www/my-blog"
          strip_components: 1
          timeout: 60s

      - name: ğŸš€ Deploy and start application on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment process on server"
            cd /home/www/my-blog || { echo "âŒ Directory not found"; exit 1; }

            echo "ğŸ§¹ Cleaning obsolete files (including SQLite Prisma residues)"
            find . -mindepth 1 -maxdepth 1 \
              ! -name 'prisma' \
              ! -name '.next' \
              ! -name 'package.json' \
              ! -name 'pnpm-lock.yaml' \
              ! -name 'public' \
              ! -name '.env' \
              -exec rm -rf {} + 2>/dev/null || true
            rm -rf prisma/*.db prisma/*.db-* 2>/dev/null || true

            echo "ğŸ“¦ Verifying deployment files"
            if [ ! -f "package.json" ] || [ ! -d ".next" ]; then
              echo "âŒ Critical files missing (package.json or .next)"
              exit 1
            fi

            echo "ğŸ”§ Ensuring pnpm is installed"
            if ! command -v pnpm &> /dev/null; then
              echo "Installing pnpm..."
              npm install -g pnpm
            fi

            echo "ğŸ“¦ Installing production dependencies"
            pnpm install --prod --frozen-lockfile --silent || { echo "âŒ Dependency install failed"; exit 1; }

            echo "ğŸ”„ Generating Prisma client (production)"
            pnpm prisma generate || { echo "âŒ Prisma client generation failed"; exit 1; }

            echo "ğŸ—„ï¸ Applying database migrations (if any)"
            pnpm prisma migrate deploy || { echo "âŒ Migration failed"; exit 1; }

            echo "ğŸ” Testing database connection"
            # ä½¿ç”¨è½»é‡æŸ¥è¯¢æµ‹è¯•è¿æ¥ï¼ˆä»…éªŒè¯è¿æ¥ï¼Œä¸æ‰§è¡Œå®é™…æ“ä½œï¼‰
            if ! pnpm prisma db execute --sql "SELECT 1;" --skip-exec &> /dev/null; then
              echo "âŒ Database connection failed"
              exit 1
            fi

            echo "âœ… Restarting application with PM2"
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              npm install -g pm2
            fi
            pm2 stop my-blog || true
            pm2 delete my-blog || true
            pm2 start "pnpm start" --name my-blog || { echo "âŒ App start failed"; exit 1; }

            echo "ğŸ“Š Application status"
            pm2 list

            echo "ğŸ‰ Deployment completed successfully!"
