name: Deploy Next.js App to Aliyun

on:
  push:
    branches:
      - main

env:
  DEPLOY_USER: appuser
  DEPLOY_PATH: /home/www/my-blog

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§± Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Generate Prisma client
        run: pnpm prisma generate
        env:
          # åªè¦ schema.prisma ä¸éœ€è¦è¿æ¥çœŸå® DBï¼Œè¿™é‡Œå¯ä»¥ç”¨å‡çš„ URL
          DATABASE_URL: "mysql://placeholder:placeholder@localhost:3306/placeholder"

      - name: ğŸ—ï¸ Build Next.js project
        run: pnpm build
        env:
          NEXT_PUBLIC_SITE_URL: https://${{ secrets.ALIYUN_SERVER_IP }}

      # ----------------------------------------------------------------
      # ä¼˜åŒ–ç‚¹ 1: å‡†å¤‡é˜¶æ®µï¼Œä¸è¿›è¡Œå¤åˆ¶ï¼Œç›´æ¥åœ¨ä¼ è¾“é˜¶æ®µå¤„ç†
      # ----------------------------------------------------------------

      - name: âœ¨ Ensure appuser exists & directories ready (root)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            id appuser || useradd -m -s /bin/bash appuser
            mkdir -p ${{ env.DEPLOY_PATH }}
            mkdir -p ${{ env.DEPLOY_PATH }}/shared/upload
            chown -R appuser:appuser ${{ env.DEPLOY_PATH }}

      # ----------------------------------------------------------------
      # ä¼˜åŒ–ç‚¹ 2: ä½¿ç”¨ rsync æ›¿ä»£ scp-action (è§£å†³ 137 å†…å­˜æº¢å‡º)
      # ----------------------------------------------------------------
      - name: ğŸ“¤ Sync files via Rsync
        run: |
          # 1. è®¾ç½® SSH ç§é’¥
          echo "${{ secrets.ALIYUN_SSH_KEY }}" > private_key
          chmod 600 private_key

          # 2. å‡†å¤‡éœ€è¦æ’é™¤çš„æ–‡ä»¶åˆ—è¡¨ (å‡å°‘ä¼ è¾“ä½“ç§¯)
          # .next/cache éå¸¸å¤§ä¸”éå¿…é¡»ï¼Œå»ºè®®æ’é™¤

          # 3. æ‰§è¡Œ Rsync å¢é‡ä¼ è¾“
          # -a: å½’æ¡£æ¨¡å¼ (ä¿ç•™æƒé™ã€æ—¶é—´ç­‰)
          # -v: æ˜¾ç¤ºè¿‡ç¨‹
          # -z: å‹ç¼©ä¼ è¾“
          # --delete: åˆ é™¤ç›®æ ‡ç›®å½•ä¸­æºç›®å½•æ²¡æœ‰çš„æ–‡ä»¶ (ä¿æŒåŒæ­¥)
          # --exclude: æ’é™¤ä¸éœ€è¦ä¸Šä¼ çš„å¤§æ–‡ä»¶

          rsync -avz --delete \
            -e "ssh -i private_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.next/cache' \
            --exclude '.env*' \
            ./.next ./package.json ./pnpm-lock.yaml ./prisma ./public \
            ${{ env.DEPLOY_USER }}@${{ secrets.ALIYUN_SERVER_IP }}:${{ env.DEPLOY_PATH }}/tmp-deploy

          # æ¸…ç†ç§é’¥
          rm private_key

      # ----------------------------------------------------------------
      # ä¼˜åŒ–ç‚¹ 3: éƒ¨ç½²é€»è¾‘ä¼˜åŒ–
      # ----------------------------------------------------------------
      - name: ğŸš€ Deploy application with PM2 (appuser)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}

            echo "ğŸ“¦ Update files from tmp-deploy"
            # ä½¿ç”¨ rsync åœ¨æœåŠ¡å™¨æœ¬åœ°åŒæ­¥ï¼Œæ¯” rm && mv æ›´å®‰å…¨ã€æ›´å¿«
            # è¿™æ ·å¦‚æœ mv å¤±è´¥ï¼Œä¸ä¼šå¯¼è‡´æ–‡ä»¶ä¸¢å¤±
            rsync -a tmp-deploy/ .

            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf tmp-deploy

            echo "ğŸ”— Linking uploads"
            mkdir -p shared/upload
            rm -rf public/upload
            ln -s ${{ env.DEPLOY_PATH }}/shared/upload ${{ env.DEPLOY_PATH }}/public/upload

            echo "ğŸ“¦ Installing production deps"
            # å¿½ç•¥è„šæœ¬ä»¥åŠ å¿«é€Ÿåº¦ï¼Œä¸”åªå®‰è£…ç”Ÿäº§ä¾èµ–
            pnpm install --prod --frozen-lockfile --ignore-scripts

            echo "ğŸ”§ Prisma & Database"
            pnpm prisma generate
            pnpm prisma migrate deploy

            echo "ğŸ”¥ Reloading PM2"
            # ä½¿ç”¨ reload è€Œä¸æ˜¯ restartï¼Œå®ç°é›¶åœæœºéƒ¨ç½² (å¦‚æœåº”ç”¨æ”¯æŒ)
            # æˆ–è€…ä½¿ç”¨ startOrReload
            if pm2 list | grep -q "my-blog"; then
              pm2 reload my-blog --update-env
            else
              pm2 start "pnpm start" --name my-blog --time
            fi

            echo "ğŸ‰ Deployment Success!"
