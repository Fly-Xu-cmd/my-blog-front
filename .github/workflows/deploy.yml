name: Deploy Next.js App to Aliyun

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯æ¨é€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install pnpm
        run: npm install -g pnpm

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ§© Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§± Generate Prisma client
        run: pnpm prisma generate

      - name: ğŸ—ï¸ Build project
        run: pnpm build

      - name: ğŸ“ Prepare deploy package
        run: |
          mkdir -p deploy
          cp -r .next package.json pnpm-lock.yaml prisma deploy/
          [ -d public ] && cp -r public deploy/public
          [ -f ecosystem.config.js ] && cp ecosystem.config.js deploy/
          [ -f .env.production ] && cp .env.production deploy/.env
          echo "âœ… Deploy package prepared successfully."
          echo "ğŸ“ Deploy package contents:"
          ls -R deploy/

      - name: ğŸ“¤ Upload build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          source: "deploy/*"
          target: "/home/www/my-blog"
          strip_components: 1

      - name: ğŸš€ Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_IP }}
          username: root
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            mkdir -p /home/www/my-blog
            cd /home/www/my-blog

            echo "ğŸ§¹ Cleaning old files (excluding prisma directory)..."
            # åªæ¸…ç†æ—§æ–‡ä»¶ï¼Œä¿ç•™prismaç›®å½•
            find . -mindepth 1 -maxdepth 1 ! -name 'prisma' ! -name '.next' ! -name 'package.json' ! -name 'pnpm-lock.yaml' ! -name 'public' -exec rm -rf {} + 2>/dev/null || true

            echo "ğŸ“¦ Checking uploaded files..."
            if [ ! -f package.json ]; then
              echo "âŒ package.json missing, aborting."
              exit 1
            fi

            echo "ğŸ“¦ Installing pnpm (if not installed)..."
            if ! command -v pnpm >/dev/null 2>&1; then
              npm install -g pnpm
            fi

            echo "ğŸ“¦ Installing production dependencies..."
            pnpm install --prod --frozen-lockfile

            echo "âœ… Restarting app with PM2..."
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi
            pm2 delete my-blog || true
            pm2 start "pnpm start" --name my-blog

            echo "ğŸ‰ Deployment complete!"
